{"_id":"zgCNx9cHdHJeNjXC","name":"Patch Actors with JD-Weird-World","type":"script","author":"UeH4lLk57wAOn2HV","img":"icons/svg/dice-target.svg","scope":"global","command":"main();\n\nasync function main() {\n  new Dialog({\n    name: \"Patch All Actors\",\n    content: `\n    <h1> Actor Patcher </h1>\n    <p> This script will overwrite <b>ALL</b> actors with skills,edges,hindrances,powers,and equipment from the SWADE-Core-Rules compendium. If an item with a matching name is found, it'll be replaced with the full text description, along with actions, and additional information</p>\n    <h1> PLEASE MAKE A BACKUP BEFORE RUNNING THIS MACRO </h1>\n    <h2> Continue? </h2> \n    `,\n    buttons: {\n      continue: {\n        label: \"Patch!\",\n        callback: async() => {\n          await patchAllActors();\n          ui.notifications.info(\"Finished patching all actors!\");\n        }\n      },\n      cancel: {\n        label: \"Cancel\"\n      }\n    }\n  }).render(true);\n}\n\nasync function patchAllActors() {\n  let updateItems = async(actor) => {\n    for(let item of actor.items) {\n      let patchedItem;\n      if(['weapon', 'armor', 'shield', 'gear'].includes(item.data.type)) {\n        //equipment pack\n        let searchID = (await game.packs.get(\"jd-weird-world.jd-equipment\").getIndex()).find(el => el.name == item.name)?._id;\n        if(searchID) {\n          patchedItem = duplicate(await game.packs.get(\"jd-weird-world.jd-equipment\").getDocument(searchID))\n          item.update(patchedItem)\n        }\n        searchID = (await game.packs.get(\"swade-core-rules.swade-equipment\").getIndex()).find(el => el.name == item.name)?._id;\n        if(searchID) {\n          patchedItem = duplicate(await game.packs.get(\"swade-core-rules.swade-equipment\").getDocument(searchID))\n          item.update(patchedItem)\n        }\n      } else if(item.data.type == \"hindrance\") {\n        if(item.name.search(/ \\(/)) {\n          searchString = item.name.split(\" (\")[0]\n        }\n        let searchID = (await game.packs.get(\"jd-weird-world.jd-hindrances\").getIndex()).find(el => el.name == searchString)?._id;\n        if(searchID) {\n          // Fuzzy matching to better patch against the savaged.us imports\n          patchedItem = duplicate(await game.packs.get(\"jd-weird-world.jd-hindrances\").getDocument(searchID))\n          item.update({\n            \"data.description\": patchedItem.data.description\n          })\n        }\n        searchID = (await game.packs.get(\"swade-core-rules.swade-hindrances\").getIndex()).find(el => el.name == searchString)?._id;\n        if(searchID) {\n          // Fuzzy matching to better patch against the savaged.us imports\n          patchedItem = duplicate(await game.packs.get(\"swade-core-rules.swade-hindrances\").getDocument(searchID))\n          item.update({\n            \"data.description\": patchedItem.data.description\n          })\n        }\n      } else if(item.data.type == \"edge\") {\n      \tlet searchString = item.name\n        if(item.name.search(/Arcane Background \\(/)) {\n        {\n        \t// do nothing to Arcane Backgrounds search\n        }\n        else if(item.name.search(/ \\(/)) {\n          searchString = item.name.split(\" (\")[0]\n        }\n        let searchID = (await game.packs.get(\"jd-weird-world.jd-edges\").getIndex()).find(el => el.name == searchString)?._id;\n        if(searchID) {\n          patchedItem = duplicate(await game.packs.get(\"jd-weird-world.jd-edges\").getDocument(searchID))\n          item.update({\n            \"data.description\": patchedItem.data.description\n          })\n        }\n        searchID = (await game.packs.get(\"swade-core-rules.swade-edges\").getIndex()).find(el => el.name == searchString)?._id;\n        if(searchID) {\n          patchedItem = duplicate(await game.packs.get(\"swade-core-rules.swade-edges\").getDocument(searchID))\n          item.update({\n            \"data.description\": patchedItem.data.description\n          })\n        }\n      } else if(item.data.type == \"skill\") {\n        let searchString = item.name\n        if([\"★ Athletics\", \"★ Notice\", \"★ Persuasion\", \"★ Stealth\", \"★ Common Knowledge\"].includes(item.name)) {\n          searchString = item.name.split(\"★ \")[1]\n        }\n        if(item.name.search(/ \\(/)) {\n          searchString = item.name.split(\" (\")[0]\n        }\n        let searchID = (await game.packs.get(\"jd-weird-world.jd-skills\").getIndex()).find(el => el.name == searchString)?._id;\n        if(searchID) {\n          patchedItem = duplicate(await game.packs.get(\"jd-weird-world.jd-skills\").getDocument(searchID))\n          item.update({\n            \"name\": item.name,\n            \"img\": patchedItem.img,\n            \"data.description\": patchedItem.data.description //Don't want to override the Die\n          })\n        }\n        searchID = (await game.packs.get(\"swade-core-rules.swade-skills\").getIndex()).find(el => el.name == searchString)?._id;\n        if(searchID) {\n          patchedItem = duplicate(await game.packs.get(\"swade-core-rules.swade-skills\").getDocument(searchID))\n          item.update({\n            \"name\": item.name,\n            \"img\": patchedItem.img,\n            \"data.description\": patchedItem.data.description //Don't want to override the Die\n          })\n        }\n      } else if(item.data.type == \"power\") {\n        let searchID = (await game.packs.get(\"jd-weird-world.jd-powers\").getIndex()).find(el => el.name == item.name)?._id;\n        if(searchID) {\n          patchedItem = duplicate(await game.packs.get(\"jd-weird-world.jd-powers\").getDocument(searchID))\n          item.update({\n            \"data.description\": patchedItem.data.description\n          })\n        }\n        searchID = (await game.packs.get(\"swade-core-rules.swade-powers\").getIndex()).find(el => el.name == item.name)?._id;\n        if(searchID) {\n          patchedItem = duplicate(await game.packs.get(\"swade-core-rules.swade-powers\").getDocument(searchID))\n          item.update({\n            \"data.description\": patchedItem.data.description\n          })\n        }\n      }\n    }\n  }\n\n  await game.actors.updateAll(async(actor) => ({\n    items: await updateItems(actor)\n  }))\n}","folder":null,"sort":0,"permission":{"default":0,"UeH4lLk57wAOn2HV":3},"flags":{"core":{"sourceId":"Macro.BmOVa1AcAV13lDIR"}}}
